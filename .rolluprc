import babel from 'rollup-plugin-babel';
import resolve from 'rollup-plugin-node-resolve';
import minify from 'rollup-plugin-babel-minify';
import visualizer from 'rollup-plugin-visualizer';

const plugins = [
  resolve(),
  minify({
    comments: false,
    banner: '/* vector class - MIT License */',
    bannerNewLine: true
  })
];

export default [
  {
    input: {
      'index': 'src/index.js',
      'operator': 'src/operator.js',
      'adapter/playcanvas': 'src/adapter/playcanvas.js'
    },
    output: [{
      dir: './build/esm',
      exports: 'named',
      format: 'esm'
    }, {
      dir: './build/cjs',
      exports: 'named',
      format: 'cjs'
    }, {
      dir: './build/amd',
      exports: 'named',
      format: 'amd'
    }],
    plugins: [
      babel({
        babelrc: false,
        exclude: 'node_modules/**',
        presets: [['@babel/preset-env', { modules: false }]]
      }),
    ].concat(plugins)
  }, ...[
    {
      input: 'src/index.js',
      output: {
        file: 'bundle.min.js',
        name: 'basics.vector'
      }
    }, {
      input: 'src/operator.js',
      output: {
        file: 'operator.min.js',
        name: 'basics.vector.operator'
      }
    }, {
      input: 'src/adapter/playcanvas.js',
      output: {
        file: 'adapter/playcanvas.min.js',
        name: 'basics.vector.adapter.playcanvas'
      }
    }
  ].map((item) => {
    const format = 'umd';
    return {
      input: item.input,
      output: {
        file: `./build/${format}/${item.output.file}`,
        name: item.output.name,
        format: format,
        exports: 'named',
        extend: true
      },
      plugins: [
        babel({
          babelrc: false,
          exclude: 'node_modules/**',
          presets: [['@babel/preset-env', {
            targets: 'last 2 versions, ie >= 11',
            corejs: '3',
            useBuiltIns: 'usage'
          }]]
        }),
        visualizer({
          filename: `./report/${item.output.name}.html`,
          template: 'treemap'
        })
      ].concat(plugins)
    }
  })
];
